# QR Code Security Flow Diagram

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        SECURE QR CODE SYSTEM FLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER SIDE (Student/Employee)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    1. User redeems reward
        â†“
    [POST /api/rewards/redeem]
        â†“
    Redemption created with unique code (RDM-ABC123)
        â†“
    User goes to "My Wallet"
        â†“
    User clicks on redemption
        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  SECURE QR GENERATION                           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  [POST /api/rewards/qr]                         â”‚
    â”‚                                                  â”‚
    â”‚  1. Validate user owns redemption               â”‚
    â”‚  2. Check redemption status (must be pending)   â”‚
    â”‚  3. Check not expired                           â”‚
    â”‚  4. Generate signature:                         â”‚
    â”‚     data = redemptionId|code|userId|rewardId|   â”‚
    â”‚            timestamp|version                    â”‚
    â”‚     signature = HMAC-SHA256(data, QR_SECRET)    â”‚
    â”‚  5. Create QR JSON:                             â”‚
    â”‚     {                                            â”‚
    â”‚       redemptionId, redemptionCode,             â”‚
    â”‚       userId, rewardId,                         â”‚
    â”‚       timestamp: now(),                         â”‚
    â”‚       signature: "abc123...",                   â”‚
    â”‚       version: "1.0"                            â”‚
    â”‚     }                                            â”‚
    â”‚  6. Return signed QR data                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    QR Code displayed with:
    â€¢ Visual QR code
    â€¢ "Secure QR â€¢ Valid for 5 minutes" badge
    â€¢ Green checkmark indicator
    â€¢ Redemption code shown


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ADMIN SIDE (Canteen Staff)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    1. Admin opens "Reward Verification"
        â†“
    2. Admin clicks "Open Camera"
        â†“
    3. Camera scans QR code OR manual entry
        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  QR CODE VALIDATION                             â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  [POST /api/admin/redemptions]                  â”‚
    â”‚                                                  â”‚
    â”‚  Step 1: Parse QR Code                          â”‚
    â”‚  â”œâ”€ Try parse as JSON                           â”‚
    â”‚  â””â”€ If fail â†’ ERROR: "Invalid QR format"        â”‚
    â”‚                                                  â”‚
    â”‚  Step 2: Check Required Fields                  â”‚
    â”‚  â”œâ”€ redemptionId?                               â”‚
    â”‚  â”œâ”€ redemptionCode?                             â”‚
    â”‚  â”œâ”€ userId?                                     â”‚
    â”‚  â”œâ”€ rewardId?                                   â”‚
    â”‚  â”œâ”€ timestamp?                                  â”‚
    â”‚  â”œâ”€ signature?                                  â”‚
    â”‚  â”œâ”€ version?                                    â”‚
    â”‚  â””â”€ If any missing â†’ ERROR: "Missing data"      â”‚
    â”‚                                                  â”‚
    â”‚  Step 3: Check Version                          â”‚
    â”‚  â”œâ”€ version === "1.0"?                          â”‚
    â”‚  â””â”€ If not â†’ ERROR: "Unsupported version"       â”‚
    â”‚                                                  â”‚
    â”‚  Step 4: Check Timestamp                        â”‚
    â”‚  â”œâ”€ age = now() - qr.timestamp                  â”‚
    â”‚  â”œâ”€ If age > 5 minutes â†’ ERROR: "Expired"       â”‚
    â”‚  â”œâ”€ If age < 0 â†’ ERROR: "Future timestamp"      â”‚
    â”‚  â””â”€ If pass â†’ Continue                          â”‚
    â”‚                                                  â”‚
    â”‚  Step 5: Verify Signature                       â”‚
    â”‚  â”œâ”€ Recreate data string:                       â”‚
    â”‚  â”‚   redemptionId|code|userId|rewardId|         â”‚
    â”‚  â”‚   timestamp|version                          â”‚
    â”‚  â”œâ”€ Calculate expected signature:               â”‚
    â”‚  â”‚   HMAC-SHA256(data, QR_SECRET)               â”‚
    â”‚  â”œâ”€ Compare with QR signature                   â”‚
    â”‚  â”œâ”€ If match â†’ âœ… VALID                         â”‚
    â”‚  â””â”€ If not match â†’ âŒ ERROR: "Fake/Tampered"    â”‚
    â”‚                                                  â”‚
    â”‚  Step 6: Check Redemption                       â”‚
    â”‚  â”œâ”€ Load from database                          â”‚
    â”‚  â”œâ”€ Status must be "pending"                    â”‚
    â”‚  â”œâ”€ Must not be expired                         â”‚
    â”‚  â””â”€ Must not be cancelled                       â”‚
    â”‚                                                  â”‚
    â”‚  Step 7: Mark as Verified                       â”‚
    â”‚  â”œâ”€ Update status to "verified"                 â”‚
    â”‚  â”œâ”€ Set verified_at timestamp                   â”‚
    â”‚  â””â”€ Log audit entry                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  SUCCESS RESPONSE                               â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  Display to admin:                              â”‚
    â”‚  â€¢ Green success box                            â”‚
    â”‚  â€¢ "âœ… Verified & Secure!"                      â”‚
    â”‚  â€¢ "ðŸ”’ Secure QR" badge                         â”‚
    â”‚  â€¢ Details: User name, Reward name              â”‚
    â”‚  â€¢ Security info:                               â”‚
    â”‚    "QR signature verified â€¢                     â”‚
    â”‚     Timestamp validated â€¢                       â”‚
    â”‚     Tampering check passed"                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SECURITY ATTACK SCENARIOS                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ATTACK 1: Screenshot Sharing
User A redeems â†’ Shows QR â†’ User B screenshots it â†’ Tries to use
â”‚
â”œâ”€ After 5 minutes: âŒ BLOCKED - "QR code has expired"
â””â”€ Before 5 min: âŒ BLOCKED - Status already "verified" from first use

ATTACK 2: Fake QR Generation
Attacker creates: {"redemptionCode": "RDM-FAKE123", ...}
â”‚
â””â”€ âŒ BLOCKED - Signature validation fails: "Invalid signature - fake"

ATTACK 3: Tampering (Edit Values)
User changes points_spent: 100 â†’ 10 in QR JSON
â”‚
â””â”€ âŒ BLOCKED - Signature doesn't match altered data

ATTACK 4: Replay Attack
Same valid QR scanned multiple times
â”‚
â”œâ”€ First scan: âœ… SUCCESS - Status: pending â†’ verified
â””â”€ Second scan: âŒ BLOCKED - Status already "verified"

ATTACK 5: Clock Manipulation
User sets device time forward to extend expiration
â”‚
â”œâ”€ Server validates with server timestamp (not client)
â””â”€ âŒ BLOCKED - "Timestamp in future" or expired

ATTACK 6: Code Swapping
User redeems cheap item, edits QR to expensive item
â”‚
â”œâ”€ Changes rewardId in QR
â””â”€ âŒ BLOCKED - Signature validation fails


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            DATA FLOW                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

GENERATION (User Side):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ QR API   â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ Supabase â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ Frontend â”‚
â”‚ (Wallet) â”‚       â”‚ /rewards â”‚       â”‚ Validate â”‚       â”‚ Display  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   /qr    â”‚       â”‚ Redmptn  â”‚       â”‚ QR Code  â”‚
                   â”‚          â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚  Create  â”‚              â–²
                   â”‚  HMAC    â”‚              â”‚
                   â”‚ Signatureâ”‚              â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
                        â”‚                    â”‚
                        â”‚                    â”‚
                        â–¼                    â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
                   â”‚ QR_SECRETâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ (Env Var)â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VALIDATION (Admin Side):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Camera  â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ Frontend â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ Admin    â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ Validate â”‚
â”‚  Scan    â”‚       â”‚ (Redmptn)â”‚       â”‚ API      â”‚       â”‚ Secure   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ /admin/  â”‚       â”‚ QR       â”‚
                                       â”‚redmptn   â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                                            â”‚                   â”‚
                                            â”‚                   â–¼
                                            â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚            â”‚ QR_SECRETâ”‚
                                            â”‚            â”‚ (Verify) â”‚
                                            â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚                   â”‚
                                            â–¼                   â–¼
                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                       â”‚ Supabase â”‚â—€â”€â”€â”€â”€â”€â”€â”‚ Valid?   â”‚
                                       â”‚ Update   â”‚       â”‚  YES/NO  â”‚
                                       â”‚ Status   â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SECURITY GUARANTEES                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… CRYPTOGRAPHIC INTEGRITY
   â€¢ HMAC-SHA256 signature
   â€¢ 256-bit security strength
   â€¢ Industry standard algorithm

âœ… FRESHNESS
   â€¢ 5-minute maximum lifetime
   â€¢ Server timestamp validation
   â€¢ No clock manipulation possible

âœ… AUTHENTICITY
   â€¢ Secret key required (QR_SECRET)
   â€¢ Unknown to users/attackers
   â€¢ Stored securely server-side only

âœ… ONE-TIME USE
   â€¢ Status check: pending â†’ verified
   â€¢ Database transaction ensures atomicity
   â€¢ Cannot reuse verified codes

âœ… BINDING
   â€¢ Tied to specific redemption ID
   â€¢ Includes user ID verification
   â€¢ Includes reward ID verification

âœ… NON-REPUDIATION
   â€¢ All attempts logged in audit_logs
   â€¢ Timestamp of verification recorded
   â€¢ Admin ID recorded


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MONITORING POINTS                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Track these metrics in production:

1. QR Generation Rate
   â””â”€ Normal: 1-2 per redemption
   â””â”€ Alert: > 10/min per user

2. Signature Failures
   â””â”€ Normal: < 1%
   â””â”€ Alert: > 5% (possible attack)

3. Expired QR Scans
   â””â”€ Normal: < 5%
   â””â”€ Alert: > 20% (UX issue or sharing)

4. Multiple Scan Attempts
   â””â”€ Normal: 1-2 per code
   â””â”€ Alert: > 5 (screenshot sharing)

5. Verification Success Rate
   â””â”€ Target: > 95%
   â””â”€ Alert: < 90%


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              END OF FLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```
